// ---------- تحديث دردشة الزبون ----------
function updateChatBox(){
  const user=localStorage.getItem('fast10CurrentUser');
  const chatDiv=document.getElementById('chatBox');
  chatDiv.innerHTML='';
  let orders=JSON.parse(localStorage.getItem('fast10Orders')||'[]');
  for(let i=orders.length-1;i>=0;i--){
    if(orders[i].user===user){
      orders[i].chat.forEach(m=>{
        let cls=m.startsWith('Fast10:')?'admin-msg':'user-msg';
        chatDiv.innerHTML+=`<div class="${cls}">${m}</div>`;
      });
      break;
    }
  }
  chatDiv.scrollTop=chatDiv.scrollHeight;
}

// ---------- عرض طلبات الزبون ----------
function renderCustomerOrders(){
  const user=localStorage.getItem('fast10CurrentUser');
  const div=document.getElementById('myOrdersList');
  div.innerHTML='';
  let orders=JSON.parse(localStorage.getItem('fast10Orders')||'[]');
  orders.forEach((o,i)=>{
    if(o.user===user){
      div.innerHTML+=`<div style="background:#222831;padding:10px;margin:5px;border-radius:8px;">
        <p>المنتج: ${o.product}</p>
        <p>السعر: ${o.price} USDT</p>
        <p>الحالة: ${o.status}</p>
      </div>`;
    }
  });
}

// ---------- عرض لوحة المدير ----------
function renderAdminOrders(){
  if(localStorage.getItem('isAdmin')!=='true') return;
  const div=document.getElementById('adminOrdersList');
  div.innerHTML='';
  let orders=JSON.parse(localStorage.getItem('fast10Orders')||'[]');
  orders.forEach((o,i)=>{
    let chatHtml=o.chat.map(m=>{
      let cls=m.startsWith('Fast10:')?'admin-msg':'user-msg';
      return `<div class="${cls}">${m}</div>`;
    }).join('');
    div.innerHTML+=`<div style="background:#222831;padding:10px;margin:5px;border-radius:8px;">
      <p>الزبون: ${o.user}</p>
      <p>المنتج: ${o.product}</p>
      <p>السعر: ${o.price} USDT</p>
      <p>الحالة: <b>${o.status}</b></p>
      <button class="status-btn accept" onclick="changeStatus(${i},'مدفوع')">مدفوع</button>
      <button class="status-btn reject" onclick="changeStatus(${i},'مرفوض')">مرفوض</button>
      <button class="status-btn confirm" onclick="changeStatus(${i},'مكتمل')">مكتمل</button>
      <div class="chat-box" id="adminChat${i}" style="max-height:150px;overflow-y:auto;margin-top:5px;">${chatHtml}</div>
      <textarea id="adminInput${i}" placeholder="اكتب ردك هنا"></textarea>
      <button onclick="sendAdminReply(${i})">إرسال</button>
    </div>`;
  });
}

// ---------- تغيير حالة الطلب ----------
function changeStatus(index,status){
  let orders=JSON.parse(localStorage.getItem('fast10Orders')||'[]');
  orders[index].status=status;
  localStorage.setItem('fast10Orders',JSON.stringify(orders));
  renderAdminOrders();
  renderCustomerOrders();
}

// ---------- إرسال رد المدير ----------
function sendAdminReply(index){
  const msg=document.getElementById('adminInput'+index).value.trim();
  if(!msg) return;
  let orders=JSON.parse(localStorage.getItem('fast10Orders')||'[]');
  orders[index].chat.push('Fast10: '+msg);
  localStorage.setItem('fast10Orders',JSON.stringify(orders));
  document.getElementById('adminInput'+index).value='';
  renderAdminOrders();
  updateChatBox();
}

// ---------- التنقل بين الصفحات ----------
function showOrder(){document.getElementById('orderPage').style.display='block';document.getElementById('customerOrders').style.display='none';document.getElementById('adminOrders').style.display='none';updateChatBox();}
function showCustomerOrders(){document.getElementById('orderPage').style.display='none';document.getElementById('customerOrders').style.display='block';document.getElementById('adminOrders').style.display='none';renderCustomerOrders();}
function showAdminOrders(){if(localStorage.getItem('isAdmin')!=='true'){alert('ليست لديك صلاحية المدير'); return;}document.getElementById('orderPage').style.display='none';document.getElementById('customerOrders').style.display='none';document.getElementById('adminOrders').style.display='block';renderAdminOrders();}

// ---------- تحديث الدردشة تلقائي كل 2 ثانية ----------
setInterval(()=>{
  updateChatBox();
  renderCustomerOrders();
  renderAdminOrders();
},2000);

// ---------- تهيئة المستخدم عند فتح الموقع ----------
if(localStorage.getItem('fast10CurrentUser')) showOrder();
